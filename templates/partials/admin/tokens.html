<!-- API Tokens -->
<section
  class="rounded-lg border bg-surface p-5"
  data-signals:_show-token-form="false"
  data-signals:_creating-token="false"
  data-signals:_token-created="false"
  data-signals:_token-value="''"
  data-signals:_token-error="''"
>
  <div class="flex flex-col gap-4">
    <div>
      <h2 class="text-lg font-semibold text-text">API Tokens</h2>
      <p class="mt-1 text-sm text-text-secondary">
        Use tokens to authenticate the CLI or REST API.
      </p>
    </div>

    {% if tokens.is_empty() %}
      <p class="text-sm text-text-muted">No active tokens.</p>
    {% else %}
      <div class="flex flex-col gap-2">
        {% for token in tokens %}
          <div
            id="token-row-{{ token.id }}"
            class="flex items-center justify-between gap-4 rounded-md bg-surface-alt px-4 py-3"
          >
            <div class="flex items-center gap-3 min-w-0">
              {{ icons::terminal("h-4 w-4 text-accent shrink-0") }}
              <div class="min-w-0">
                <span class="block text-sm font-semibold text-text"
                  >{{ token.name }}</span
                >
                <span class="block text-xs text-text-muted">
                  Created {{ token.created_at }} ·
                  {% if let Some(last_used) = token.last_used_at %}
                    Last used {{ last_used }}
                  {% else %}
                    Never used
                  {% endif %}
                </span>
              </div>
            </div>
            <button
              type="button"
              class="shrink-0 inline-flex items-center justify-center rounded-md border text-accent transition hover:text-text hover:bg-surface-alt h-8 w-8 sm:h-auto sm:w-auto sm:gap-2 sm:px-4 sm:py-2 sm:text-sm sm:font-medium"
              onclick="revokeToken({{ token.id }}, '{{ token.name }}')"
              aria-label="Revoke token"
            >
              {{ icons::delete("h-4 w-4") }}
              <span class="hidden sm:inline">Revoke</span>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Create token form -->
    <div
      class="rounded-md border bg-surface-alt p-4"
      data-show="$_showTokenForm && !$_tokenCreated"
      style="display: none"
    >
      <p
        data-show="$_tokenError"
        data-text="$_tokenError"
        style="display: none"
        class="mb-3 rounded-md bg-error-bg border border-error-border p-2 text-sm text-error-text"
        role="alert"
      ></p>
      <form
        data-on:submit="$_creatingToken = true; $_tokenError = ''; @post('/api/v1/tokens', {contentType: 'form'})"
        data-on:datastar-fetch="if (!$_creatingToken) return;
        if (evt.detail.type === 'finished') { $_creatingToken = false; document.getElementById('token-name').value = '' }
        else if (evt.detail.type === 'error') { $_creatingToken = false; $_tokenError = 'Failed to create token.' }"
      >
        <div class="flex flex-col gap-3 sm:flex-row sm:items-end">
          <label class="flex flex-col gap-1 text-sm sm:flex-1">
            <span class="text-text">Token Name</span>
            <input
              type="text"
              name="name"
              id="token-name"
              required
              aria-required="true"
              class="input-field"
              placeholder="e.g. laptop-cli, ci-server"
            />
          </label>
          <div class="flex gap-3">
            <button
              type="submit"
              class="flex-1 inline-flex items-center justify-center gap-2 rounded-md bg-accent px-4 py-2 text-sm font-semibold text-accent-text transition hover:bg-accent-hover disabled:opacity-50 disabled:cursor-not-allowed sm:flex-initial"
              data-attr:disabled="$_creatingToken"
            >
              {{ icons::plus("h-4 w-4") }} Create
            </button>
            <button
              type="button"
              data-on:click="$_showTokenForm = false; $_tokenError = ''"
              class="flex-1 inline-flex items-center justify-center gap-2 rounded-md border px-4 py-2 text-sm font-medium text-text transition hover:bg-surface-alt sm:flex-initial"
            >
              {{ icons::x_mark("h-4 w-4") }} Cancel
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- One-time token display -->
    <div
      data-show="$_tokenCreated"
      style="display: none"
      class="relative rounded-md border border-success-border bg-success-bg p-4"
    >
      <button
        type="button"
        onclick="window.location.reload()"
        class="absolute top-3.5 right-3 inline-flex h-6 w-6 items-center justify-center rounded text-success-text transition hover:opacity-70"
        aria-label="Dismiss"
      >
        {{ icons::x_mark("h-4 w-4") }}
      </button>
      <p class="pr-6 text-sm font-medium text-success-text">
        Token created! Copy it now — it will not be shown again.
      </p>
      <div class="mt-3 flex items-center gap-2">
        <code
          id="token-value"
          data-text="$_tokenValue"
          class="flex-1 rounded bg-surface px-3 py-2 text-sm font-mono text-text border border-success-border break-all select-all"
        ></code>
        <button
          type="button"
          onclick="copyToken(this)"
          class="shrink-0 inline-flex items-center gap-2 rounded-md bg-success px-3 py-1.5 text-sm font-medium text-accent-text transition hover:bg-success"
        >
          {{ icons::clipboard("h-4 w-4") }} Copy
        </button>
      </div>
    </div>

    <div>
      <button
        type="button"
        data-show="!$_showTokenForm && !$_tokenCreated"
        data-on:click="$_showTokenForm = true; setTimeout(() => document.getElementById('token-name').focus(), 50)"
        class="inline-flex w-full items-center justify-center gap-2 rounded-md bg-accent px-4 py-2 text-sm font-semibold text-accent-text transition hover:bg-accent-hover sm:w-auto sm:min-w-44"
      >
        {{ icons::terminal("h-4 w-4") }} New Token
      </button>
    </div>
  </div>
</section>
