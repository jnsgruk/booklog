{% extends "base.html" %} {% import "partials/icons.html" as icons %}
{% block title %}Booklog · Admin{% endblock %}
{% block head %}
  <script src="/static/js/webauthn.js"></script>
{% endblock %}
{% block content %}
  <header class="flex flex-col gap-2">
    <h1 class="text-3xl font-semibold">Admin</h1>
    <p class="max-w-2xl text-sm text-text-secondary">
      Manage passkeys, API tokens, and data.
    </p>
  </header>

  {% include "partials/admin/passkeys.html" %}
  {% include "partials/admin/tokens.html" %}
  {% include "partials/admin/data.html" %}

  <!-- AI Usage -->
  {% if let Some(usage) = ai_usage %}
    <section class="rounded-lg border bg-surface p-5">
      <div class="flex flex-col gap-4">
        <h2 class="text-lg font-semibold text-text">AI Usage</h2>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <span class="block text-sm text-text-muted">Total Cost</span>
            <span class="mt-1 block text-lg font-semibold text-text"
              >{{ usage.cost }}</span
            >
          </div>
          <div>
            <span class="block text-sm text-text-muted">API Calls</span>
            <span class="mt-1 block text-lg font-semibold text-text"
              >{{ usage.calls }}</span
            >
          </div>
          <div>
            <span class="block text-sm text-text-muted">Total Tokens</span>
            <span class="mt-1 block text-lg font-semibold text-text"
              >{{ usage.tokens }}</span
            >
          </div>
        </div>
      </div>
    </section>
  {% endif %}

  <!-- Users (admin only) -->
  {% if is_admin %}
    <section class="rounded-lg border bg-surface p-5">
      <div class="flex flex-col gap-4">
        <div>
          <h2 class="text-lg font-semibold text-text">Users</h2>
          <p class="mt-1 text-sm text-text-secondary">All registered users.</p>
        </div>

        {% if users.is_empty() %}
          <p class="text-sm text-text-muted">No users found.</p>
        {% else %}
          <div class="flex flex-col gap-2">
            {% for user in users %}
              <div
                class="flex items-center justify-between gap-4 rounded-md bg-surface-alt px-4 py-3"
              >
                <div class="flex items-center gap-3 min-w-0">
                  {{ icons::user("h-4 w-4 text-accent shrink-0") }}
                  <div class="min-w-0">
                    <span class="block text-sm font-semibold text-text">
                      {{ user.username }}
                      {% if user.is_admin %}
                        <span class="pill pill-muted ml-1">admin</span>
                      {% endif %}
                    </span>
                    <span class="block text-xs text-text-muted">
                      Joined {{ user.created_at }}
                    </span>
                  </div>
                </div>
                {% if user.id != current_user_id %}
                  <button
                    type="button"
                    class="shrink-0 inline-flex items-center justify-center rounded-md border text-accent transition hover:text-text hover:bg-surface-alt h-8 w-8 sm:h-auto sm:w-auto sm:gap-2 sm:px-4 sm:py-2 sm:text-sm sm:font-medium"
                    onclick="startImpersonation({{ user.id }}, '{{ user.username }}')"
                    aria-label="View as {{ user.username }}"
                  >
                    {{ icons::eye("h-4 w-4") }}
                    <span class="hidden sm:inline">View as</span>
                  </button>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Invite -->
    <section
      class="rounded-lg border bg-surface p-5"
      data-signals:_invite-url="''"
      data-signals:_invite-created="false"
      data-signals:_invite-creating="false"
      data-signals:_invite-error="''"
    >
      <div class="flex flex-col gap-4">
        <div>
          <h2 class="text-lg font-semibold text-text">Invite</h2>
          <p class="mt-1 text-sm text-text-secondary">
            Generate a one-time registration link. Valid for 7 days.
          </p>
        </div>

        <p
          data-show="$_inviteError"
          data-text="$_inviteError"
          style="display: none"
          class="rounded-md bg-error-bg border border-error-border p-2 text-sm text-error-text"
          role="alert"
        ></p>

        <!-- Invite URL display -->
        <div
          data-show="$_inviteCreated"
          style="display: none"
          class="relative rounded-md border border-success-border bg-success-bg p-4"
        >
          <button
            type="button"
            data-on:click="$_inviteCreated = false; $_inviteUrl = ''"
            class="absolute top-3.5 right-3 inline-flex h-6 w-6 items-center justify-center rounded text-success-text transition hover:opacity-70"
            aria-label="Dismiss"
          >
            {{ icons::x_mark("h-4 w-4") }}
          </button>
          <p class="pr-6 text-sm font-medium text-success-text">
            Invite link created. Copy it now — it will not be shown again.
          </p>
          <div class="mt-3 flex items-center gap-2">
            <code
              id="invite-url-value"
              data-text="$_inviteUrl"
              class="flex-1 rounded bg-surface px-3 py-2 text-sm font-mono text-text border border-success-border break-all select-all"
            ></code>
            <button
              type="button"
              onclick="copyInviteUrl(this)"
              class="shrink-0 inline-flex items-center gap-2 rounded-md bg-success px-3 py-1.5 text-sm font-medium text-accent-text transition hover:bg-success"
            >
              {{ icons::clipboard("h-4 w-4") }} Copy
            </button>
          </div>
        </div>

        <div data-show="!$_inviteCreated">
          <button
            type="button"
            data-on:click="$_inviteCreating = true; $_inviteError = ''; @post('/api/v1/admin/invite')"
            data-on:datastar-fetch="if (!$_inviteCreating) return;
            if (evt.detail.type === 'finished') { $_inviteCreating = false }
            else if (evt.detail.type === 'error') { $_inviteCreating = false; $_inviteError = 'Failed to generate invite link.' }"
            data-attr:disabled="$_inviteCreating"
            class="inline-flex w-full items-center justify-center gap-2 rounded-md bg-accent px-4 py-2 text-sm font-semibold text-accent-text transition hover:bg-accent-hover disabled:opacity-50 disabled:cursor-not-allowed sm:w-auto sm:min-w-44"
          >
            <span data-show="!$_inviteCreating"
              >{{ icons::plus("h-4 w-4") }}</span
            >
            <span data-show="$_inviteCreating" style="display:none"
              >{{ icons::spinner("h-4 w-4") }}</span
            >
            Generate Invite Link
          </button>
        </div>
      </div>
    </section>
  {% endif %}

  <!-- Sign Out -->
  <section class="rounded-lg border bg-surface p-5">
    <div class="flex flex-col gap-4">
      <div>
        <h2 class="text-lg font-semibold text-text">Sign Out</h2>
        <p class="mt-1 text-sm text-text-secondary">Sign out on this device.</p>
      </div>
      <div>
        <form method="post" action="/logout">
          <button
            type="submit"
            class="inline-flex w-full items-center justify-center gap-2 rounded-md border px-4 py-2 text-sm font-medium text-accent transition hover:text-text hover:bg-surface-alt sm:w-auto sm:min-w-44"
          >
            {{ icons::logout("h-4 w-4") }} Sign Out
          </button>
        </form>
      </div>
    </div>
  </section>

  <script>
    // --- Passkey form ---

    const registerPasskey = async () => {
      const name = document.getElementById("passkey-name").value.trim();
      const errorEl = document.getElementById("add-passkey-error");
      const loadingEl = document.getElementById("add-passkey-loading");
      const btn = document.getElementById("add-passkey-btn");

      if (!name) {
        errorEl.textContent = "Please enter a name for this passkey.";
        errorEl.classList.remove("hidden");
        return;
      }

      errorEl.classList.add("hidden");
      loadingEl.classList.remove("hidden");
      btn.disabled = true;

      try {
        await addPasskey(name);
        window.location.reload();
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.remove("hidden");
        loadingEl.classList.add("hidden");
        btn.disabled = false;
      }
    };

    // --- Token ---

    const copyToken = (btn) => {
      const token = document.getElementById("token-value").textContent;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(token).then(() => {
          btn.textContent = "Copied!";
          setTimeout(() => {
            btn.textContent = "Copy";
          }, 2000);
        });
      } else {
        const range = document.createRange();
        range.selectNodeContents(document.getElementById("token-value"));
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      }
    };

    // --- Data management ---

    const restoreFromFile = async (input) => {
      const file = input.files[0];
      if (!file) return;
      input.value = "";

      if (
        !confirm(
          "Restore from backup? This will replace all data.\n\nThe database must be empty for restore to succeed.",
        )
      ) {
        return;
      }

      const status = document.getElementById("backup-status");
      const error = document.getElementById("backup-error");
      status.classList.add("hidden");
      error.classList.add("hidden");

      try {
        const text = await file.text();
        JSON.parse(text);

        const response = await fetch("/api/v1/backup/restore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: text,
        });

        if (response.status === 409) {
          throw new Error(
            "Database is not empty. Restore requires an empty database.",
          );
        }
        if (!response.ok) {
          throw new Error(`Restore failed (HTTP ${response.status}).`);
        }

        status.textContent = "Backup restored successfully.";
        status.classList.remove("hidden");
      } catch (err) {
        error.textContent =
          err instanceof SyntaxError ? "Invalid JSON file." : err.message;
        error.classList.remove("hidden");
      }
    };

    const resetDatabase = async () => {
      if (
        !confirm(
          "Reset all book data?\n\nThis will permanently delete all authors, books, library entries, and timeline events.\n\nThis cannot be undone.",
        )
      ) {
        return;
      }

      if (!confirm("Confirm? All book data will be permanently deleted.")) {
        return;
      }

      const status = document.getElementById("backup-status");
      const error = document.getElementById("backup-error");
      status.classList.add("hidden");
      error.classList.add("hidden");

      try {
        const response = await fetch("/api/v1/backup/reset", {
          method: "POST",
        });

        if (!response.ok) {
          throw new Error(`Reset failed (HTTP ${response.status}).`);
        }

        status.textContent =
          "Database reset successfully. All book data has been deleted.";
        status.classList.remove("hidden");
      } catch (err) {
        error.textContent = err.message;
        error.classList.remove("hidden");
      }
    };

    const deletePasskey = async (id, name) => {
      if (!confirm(`Delete passkey "${name}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/v1/passkeys/${id}`, {
          method: "DELETE",
        });
        if (response.ok) {
          window.location.reload();
        } else if (response.status === 409) {
          alert("Cannot delete the only passkey. Add another passkey first.");
        } else {
          alert("Failed to delete passkey.");
        }
      } catch (err) {
        alert(`Failed to delete passkey: ${err.message}`);
      }
    };

    // --- Invite ---

    const copyInviteUrl = (btn) => {
      const url = document.getElementById("invite-url-value").textContent;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          btn.textContent = "Copied!";
          setTimeout(() => {
            btn.textContent = "Copy";
          }, 2000);
        });
      } else {
        const range = document.createRange();
        range.selectNodeContents(document.getElementById("invite-url-value"));
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      }
    };

    const startImpersonation = async (userId, username) => {
      if (!confirm(`View the app as "${username}"?`)) return;

      try {
        const response = await fetch(`/api/v1/admin/impersonate/${userId}`, {
          method: "POST",
        });
        if (response.ok) {
          window.location.href = "/";
        } else {
          alert("Failed to start impersonation.");
        }
      } catch (err) {
        alert(`Failed to start impersonation: ${err.message}`);
      }
    };

    const revokeToken = async (id, name) => {
      if (!confirm(`Revoke token "${name}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/v1/tokens/${id}/revoke`, {
          method: "POST",
        });
        if (response.ok) {
          const row = document.getElementById(`token-row-${id}`);
          if (row) row.remove();
        } else {
          alert("Failed to revoke token.");
        }
      } catch (err) {
        alert(`Failed to revoke token: ${err.message}`);
      }
    };
  </script>
{% endblock %}
